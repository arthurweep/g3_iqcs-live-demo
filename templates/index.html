<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能玻璃质量控制系统 (IQCS)</title>
    <style>
        /* CSS 样式与之前提供的保持一致，以确保界面美观和工业化设计 */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background-color: #f4f7f6;
            color: #333;
            line-height: 1.6;
        }
        .container {
            max-width: 900px;
            margin: 30px auto;
            background-color: #ffffff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        h1, h2 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 25px;
        }
        .section {
            margin-bottom: 30px;
            border-bottom: 1px solid #eee;
            padding-bottom: 20px;
        }
        .section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }
        input[type="number"], input[type="text"] {
            width: calc(100% - 20px);
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 16px;
        }
        button {
            background-color: #3498db;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
            margin-right: 10px;
        }
        button:hover {
            background-color: #2980b9;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .result-box {
            background-color: #ecf0f1;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            border: 1px solid #dcdcdc;
        }
        .result-box h3 {
            margin-top: 0;
            color: #2c3e50;
        }
        .result-box p {
            margin-bottom: 5px;
        }
        .result-box .status-qualified {
            color: #27ae60; /* Green for qualified */
            font-weight: bold;
        }
        .result-box .status-unqualified {
            color: #e74c3c; /* Red for unqualified */
            font-weight: bold;
        }
        .warnings-box {
            background-color: #fcf8e3; /* Light yellow */
            border: 1px solid #fbeed5;
            color: #c09853;
            padding: 15px;
            margin-top: 15px;
            border-radius: 8px;
        }
        .warnings-box ul {
            list-style-type: disc;
            margin-left: 20px;
            padding-left: 0;
        }
        .suggestions-box {
            background-color: #d9edf7; /* Light blue */
            border: 1px solid #bce8f1;
            color: #31708f;
            padding: 15px;
            margin-top: 15px;
            border-radius: 8px;
        }
        .suggestions-box ul {
            list-style-type: decimal; /* Numbered list for suggestions */
            margin-left: 20px;
            padding-left: 0;
        }
        .message-box {
            background-color: #dff0d8; /* Light green for success */
            color: #3c763d;
            border: 1px solid #d6e9c6;
            padding: 10px;
            margin-top: 10px;
            border-radius: 5px;
            display: none; /* Hidden by default */
        }
        .message-box.error {
            background-color: #f2dede; /* Light red for error */
            color: #a94442;
            border-color: #ebccd1;
        }
        footer {
            text-align: center;
            margin-top: 40px;
            font-size: 0.9em;
            color: #777;
        }
        /* 引入 Font Awesome 图标，用于增强视觉效果 */
        @import url("https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css");
    </style>
</head>
<body>
    <div class="container">
        <h1>智能玻璃质量控制系统 (IQCS)</h1>

        <div class="section">
            <h2>1. 模型训练</h2>
            <p>首次运行或数据更新后，请点击下方按钮训练模型。</p>
            <button id="trainModelBtn">训练模型</button>
            <div id="trainMessage" class="message-box"></div>
        </div>

        <div class="section">
            <h2>2. 质量判定与优化建议</h2>
            <form id="predictForm">
                <!-- 输入字段名称和默认值与您提供的UI图像 [1] 完全一致 -->
                <label for="paramA">参数A (例如: 15.5):</label>
                <input type="number" id="paramA" name="参数A" step="0.01" value="15.0" required>

                <label for="paramB">参数B (例如: 10.2):</label>
                <input type="number" id="paramB" name="参数B" step="0.01" value="10.0" required>

                <label for="paramC">参数C (例如: 110):</label>
                <input type="number" id="paramC" name="参数C" step="1" value="110" required>

                <label for="paramD">参数D (例如: 0.95):</label>
                <input type="number" id="paramD" name="参数D" step="0.01" value="0.95" required>
                
                <label for="paramE">参数E (例如: 60):</label>
                <input type="number" id="paramE" name="参数E" step="1" value="60" required>

                <!-- 确保这里的name属性与app.py中的特征名称以及GOLDEN_BASELINE的键名一致 -->
                
                <button type="submit" id="predictBtn">进行质量判定</button>
            </form>
            <div id="predictResults" class="result-box">
                <!-- 预测结果将显示在这里 -->
            </div>
            <div id="predictMessage" class="message-box"></div>
        </div>
    </div>

    <footer>
        <p>&copy; 2025 智能玻璃质量控制系统. 保留所有权利.</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const trainModelBtn = document.getElementById('trainModelBtn');
            const trainMessageDiv = document.getElementById('trainMessage');
            const predictForm = document.getElementById('predictForm');
            const predictResultsDiv = document.getElementById('predictResults');
            const predictMessageDiv = document.getElementById('predictMessage');
            const predictBtn = document.getElementById('predictBtn');

            // 辅助函数：显示消息
            function showMessage(div, message, isError = false) {
                div.textContent = message;
                div.className = `message-box ${isError ? 'error' : ''}`;
                div.style.display = 'block';
                setTimeout(() => {
                    div.style.display = 'none';
                }, 5000); // 5秒后自动隐藏
            }

            // 模型训练按钮事件
            trainModelBtn.addEventListener('click', async () => {
                trainModelBtn.disabled = true;
                trainModelBtn.textContent = '训练中...';
                predictBtn.disabled = true; // 训练时禁用预测按钮
                predictResultsDiv.innerHTML = ''; // 清空之前的预测结果

                try {
                    const response = await fetch('/train', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    const data = await response.json();

                    if (response.ok) {
                        showMessage(trainMessageDiv, data.message);
                    } else {
                        showMessage(trainMessageDiv, `训练失败: ${data.message}`, true);
                    }
                } catch (error) {
                    showMessage(trainMessageDiv, `网络或服务器错误: ${error.message}`, true);
                } finally {
                    trainModelBtn.disabled = false;
                    trainModelBtn.textContent = '训练模型';
                    predictBtn.disabled = false; // 训练完成后启用预测按钮
                }
            });

            // 质量判定表单提交事件
            predictForm.addEventListener('submit', async (event) => {
                event.preventDefault(); // 阻止表单默认提交行为

                predictBtn.disabled = true;
                predictBtn.textContent = '判定中...';
                predictResultsDiv.innerHTML = ''; // 清空之前的预测结果
                predictMessageDiv.style.display = 'none';

                const formData = new FormData(predictForm);
                const inputData = {};
                formData.forEach((value, key) => {
                    inputData[key] = parseFloat(value); // 将字符串转换为浮点数
                });

                try {
                    const response = await fetch('/predict', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(inputData)
                    });
                    const data = await response.json();

                    if (response.ok) {
                        let resultHTML = `
                            <h3>判定结果: <span class="${data.prediction === '合格' ? 'status-qualified' : 'status-unqualified'}">${data.prediction}</span></h3>
                            <p>置信度: ${data.confidence}</p>
                        `;

                        // 显示预警信息 (如果有)
                        if (data.warnings && data.warnings.length > 0) {
                            resultHTML += `
                                <div class="warnings-box">
                                    <h4><i class="fas fa-exclamation-triangle"></i> 工艺参数预警:</h4>
                                    <ul>
                            `;
                            data.warnings.forEach(warning => {
                                resultHTML += `<li>${warning}</li>`;
                            });
                            resultHTML += `
                                    </ul>
                                    <p>即使模型预测合格，上述参数仍超出黄金基线范围，建议关注。</p>
                                </div>
                            `;
                        }

                        // 显示优化建议 (如果预测不合格且有建议)
                        if (data.prediction === '不合格' && data.suggestions && data.suggestions.length > 0) {
                            resultHTML += `
                                <div class="suggestions-box">
                                    <h4><i class="fas fa-lightbulb"></i> 智能优化建议:</h4>
                                    <ul>
                            `;
                            data.suggestions.forEach(suggestion => {
                                resultHTML += `<li>${suggestion}</li>`;
                            });
                            resultHTML += `
                                    </ul>
                                    <p>请参考以上建议调整工艺参数，以提升产品质量。</p>
                                </div>
                            `;
                        } else if (data.prediction === '不合格' && (!data.suggestions || data.suggestions.length === 0)) {
                             resultHTML += `
                                <div class="suggestions-box">
                                    <h4><i class="fas fa-info-circle"></i> 智能优化建议:</h4>
                                    <p>当前未能生成详细的优化建议。请确保模型已正确训练，并检查输入参数的有效性。</p>
                                </div>
                            `;
                        }
                        
                        predictResultsDiv.innerHTML = resultHTML;
                        predictResultsDiv.style.display = 'block';

                    } else {
                        showMessage(predictMessageDiv, `判定失败: ${data.message}`, true);
                        predictResultsDiv.style.display = 'none';
                    }
                } catch (error) {
                    showMessage(predictMessageDiv, `网络或服务器错误: ${error.message}`, true);
                    predictResultsDiv.style.display = 'none';
                } finally {
                    predictBtn.disabled = false;
                    predictBtn.textContent = '进行质量判定';
                }
            });
            
            // 页面加载后尝试训练模型一次（可选，便于调试）
            // trainModelBtn.click();
        });
    </script>
</body>
</html>
