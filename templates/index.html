<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>广州福耀智能质检系统 (IQCS)</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background-color: #f4f7f6;
            color: #333;
            line-height: 1.6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        h1, h2, h3 {
            color: #2c3e50;
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 10px;
            margin-top: 30px;
        }
        h2 {
            font-size: 1.8em;
        }
        h3 {
            font-size: 1.4em;
        }
        .section {
            margin-bottom: 40px;
            padding: 20px;
            background-color: #fdfdfd;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        input[type="file"],
        input[type="text"],
        input[type="number"],
        button {
            padding: 10px 15px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 1em;
            width: calc(100% - 22px);
            box-sizing: border-box;
            margin-top: 5px;
        }
        input[type="text"],
        input[type="number"] {
            width: 200px; /* Adjust width for parameter inputs */
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s ease;
            width: auto;
            min-width: 120px;
        }
        button:hover {
            background-color: #2980b9;
        }
        button:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }
        .results-box {
            background-color: #ecf0f1;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            padding: 15px;
            margin-top: 20px;
            white-space: pre-wrap; /* Preserve whitespace and line breaks */
            word-wrap: break-word; /* Break long words */
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 0.9em;
            max-height: 500px;
            overflow-y: auto;
        }
        .status-ok { color: green; font-weight: bold; }
        .status-ng { color: red; font-weight: bold; }
        .status-warning { color: orange; font-weight: bold; }
        .image-container {
            text-align: center;
            margin-top: 20px;
        }
        .image-container img {
            max-width: 100%;
            height: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .param-input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .param-input-grid .form-group {
            margin-bottom: 0;
        }
        .button-group {
            margin-top: 20px;
            display: flex;
            gap: 10px;
        }
        .suggestion-box {
            background-color: #e8f5e9;
            border: 1px solid #a5d6a7;
            padding: 15px;
            margin-top: 20px;
            border-radius: 4px;
        }
        .prob-change {
            font-weight: bold;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>广州福耀智能质检系统 (IQCS)</h1>
        <p>欢迎使用智能质检系统。本系统旨在通过AI技术，实现玻璃预处理产线的质量优化和管理。</p>

        <div class="section">
            <h2>1. 模型训练与管理</h2>
            <p>上传历史生产数据 (CSV文件)，训练AI模型。</p>
            <div class="form-group">
                <label for="csvFile">上传 CSV 文件:</label>
                <input type="file" id="csvFile" accept=".csv">
            </div>
            <button onclick="trainModel()">开始训练模型</button>
            <div id="trainResults" class="results-box"></div>
            <div id="featureImportancePlot" class="image-container"></div>
        </div>

        <div class="section">
            <h2>2. 产线心电图 (Process Monitor)</h2>
            <p>实时监控工艺参数是否在“黄金工艺基线”范围内，提前预警异常波动。</p>
            <div class="param-input-grid">
                <!-- 示例参数，请根据实际情况添加更多参数 -->
                <div class="form-group">
                    <label for="monitor_F_cut_act">刀头压力 (F_cut_act):</label>
                    <input type="number" id="monitor_F_cut_act" value="10.5" step="0.1">
                </div>
                <div class="form-group">
                    <label for="monitor_v_cut_act">切割速度 (v_cut_act):</label>
                    <input type="number" id="monitor_v_cut_act" value="150" step="1">
                </div>
                <div class="form-group">
                    <label for="monitor_F_break_peak">掰边力峰值 (F_break_peak):</label>
                    <input type="number" id="monitor_F_break_peak" value="25" step="0.1">
                </div>
                <div class="form-group">
                    <label for="monitor_t_glass_meas">玻璃厚度 (t_glass_meas):</label>
                    <input type="number" id="monitor_t_glass_meas" value="2.1" step="0.1">
                </div>
                <div class="form-group">
                    <label for="monitor_grinding_speed">磨削速度 (grinding_speed):</label>
                    <input type="number" id="monitor_grinding_speed" value="80" step="1">
                </div>
                <!-- 更多参数... -->
            </div>
            <button onclick="monitorProcess()">开始监控</button>
            <div id="monitorResults" class="results-box"></div>
        </div>

        <div class="section">
            <h2>3. AI工艺员 (Recommended Parameters)</h2>
            <p>根据产品ID推荐最佳开机参数，缩短调试周期。</p>
            <div class="form-group">
                <label for="partId">产品ID (Part_ID):</label>
                <input type="text" id="partId" value="ABC-12345">
            </div>
            <button onclick="recommendParameters()">获取推荐参数</button>
            <div id="recommendResults" class="results-box"></div>
        </div>

        <div class="section">
            <h2>4. AI侦探 (Quality Prediction & Adjustment Suggestion)</h2>
            <p>输入当前生产参数，AI秒级诊断质量问题并提供调优建议。</p>
            <div class="param-input-grid">
                <!-- 示例参数，请根据实际情况添加更多参数 -->
                <div class="form-group">
                    <label for="predict_F_cut_act">刀头压力 (F_cut_act):</label>
                    <input type="number" id="predict_F_cut_act" value="10.5" step="0.1">
                </div>
                <div class="form-group">
                    <label for="predict_v_cut_act">切割速度 (v_cut_act):</label>
                    <input type="number" id="predict_v_cut_act" value="150" step="1">
                </div>
                <div class="form-group">
                    <label for="predict_F_break_peak">掰边力峰值 (F_break_peak):</label>
                    <input type="number" id="predict_F_break_peak" value="25" step="0.1">
                </div>
                <div class="form-group">
                    <label for="predict_t_glass_meas">玻璃厚度 (t_glass_meas):</label>
                    <input type="number" id="predict_t_glass_meas" value="2.1" step="0.1">
                </div>
                <div class="form-group">
                    <label for="predict_grinding_speed">磨削速度 (grinding_speed):</label>
                    <input type="number" id="predict_grinding_speed" value="80" step="1">
                </div>
                <!-- 更多参数，确保名称与 app.py 中的 features 列表一致 -->
            </div>
            <button onclick="predictQuality()">诊断质量</button>
            <div id="predictResults" class="results-box"></div>
            <div id="shapPlotContainer" class="image-container"></div>
            <div class="button-group" id="suggestionButtonGroup" style="display: none;">
                <button onclick="getAdjustmentSuggestion()">获取调优建议</button>
            </div>
            <div id="adjustmentSuggestionResults" class="suggestion-box" style="display: none;"></div>
        </div>

    </div>

    <script>
        // 用于存储从 /api/predict 获得的原始参数，供后续调优建议使用
        let currentOriginalParams = null; 

        // --- 通用函数 ---
        function displayMessage(elementId, message, isHtml = false, className = '') {
            const element = document.getElementById(elementId);
            if (isHtml) {
                element.innerHTML = message;
            } else {
                element.textContent = message;
            }
            element.className = 'results-box ' + className; // Reset and apply class
        }

        function clearResults(elementId) {
            const element = document.getElementById(elementId);
            element.innerHTML = '';
            element.className = 'results-box'; // Reset class
        }

        function displayImage(elementId, base64Image) {
            const container = document.getElementById(elementId);
            container.innerHTML = ''; // Clear previous image
            if (base64Image) {
                const img = document.createElement('img');
                img.src = 'data:image/png;base64,' + base64Image;
                container.appendChild(img);
            }
        }

        function getParameterInputs(prefix) {
            const inputs = document.querySelectorAll(`#${prefix}_F_cut_act, #${prefix}_v_cut_act, #${prefix}_F_break_peak, #${prefix}_t_glass_meas, #${prefix}_grinding_speed`);
            const params = {};
            inputs.forEach(input => {
                // Remove prefix to get actual parameter name
                const paramName = input.id.replace(`${prefix}_`, ''); 
                params[paramName] = parseFloat(input.value);
            });
            return params;
        }

        // --- 模块 1: 模型训练 ---
        async function trainModel() {
            clearResults('trainResults');
            displayImage('featureImportancePlot', null);
            const fileInput = document.getElementById('csvFile');
            const file = fileInput.files[0];

            if (!file) {
                displayMessage('trainResults', '请选择一个CSV文件！', false, 'status-ng');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('/api/train', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();

                if (response.ok) {
                    let msg = `<h3>${result.message}</h3>`;
                    msg += `<p><strong>模型性能:</strong></p>`;
                    for (const key in result.performance) {
                        if (typeof result.performance[key] === 'number') {
                            msg += `<p>- ${key.replace(/_/g, ' ')}: ${(result.performance[key] * 100).toFixed(2)}%</p>`;
                        } else {
                            msg += `<p>- ${key.replace(/_/g, ' ')}: ${result.performance[key]}</p>`;
                        }
                    }
                    displayMessage('trainResults', msg, true, 'status-ok');
                    displayImage('featureImportancePlot', result.feature_importance_plot);
                } else {
                    displayMessage('trainResults', `训练失败: ${result.error}`, false, 'status-ng');
                }
            } catch (error) {
                displayMessage('trainResults', `网络或服务器错误: ${error}`, false, 'status-ng');
            }
        }

        // --- 模块 2: 产线心电图 ---
        async function monitorProcess() {
            clearResults('monitorResults');
            const params = getParameterInputs('monitor');

            try {
                const response = await fetch('/api/monitor', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(params)
                });
                const result = await response.json();

                if (response.ok) {
                    if (result.status === 'Abnormal') {
                        let msg = `<span class="status-warning">${result.message}</span><br>`;
                        msg += `<strong>详情:</strong><br>${result.details.join('<br>')}`;
                        displayMessage('monitorResults', msg, true, 'status-warning');
                    } else {
                        displayMessage('monitorResults', result.message, false, 'status-ok');
                    }
                } else {
                    displayMessage('monitorResults', `监控失败: ${result.error}`, false, 'status-ng');
                }
            } catch (error) {
                displayMessage('monitorResults', `网络或服务器错误: ${error}`, false, 'status-ng');
            }
        }

        // --- 模块 3: AI工艺员 ---
        async function recommendParameters() {
            clearResults('recommendResults');
            const partId = document.getElementById('partId').value;

            if (!partId) {
                displayMessage('recommendResults', '请输入产品ID！', false, 'status-ng');
                return;
            }

            try {
                const response = await fetch('/api/recommend', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ Part_ID: partId })
                });
                const result = await response.json();

                if (response.ok) {
                    let msg = `<p>${result.message}</p>`;
                    msg += `<strong>推荐参数:</strong><br>`;
                    for (const key in result.recommended_params) {
                        msg += `- ${key}: ${result.recommended_params[key].toFixed(2)}<br>`;
                    }
                    displayMessage('recommendResults', msg, true, 'status-ok');
                } else {
                    displayMessage('recommendResults', `推荐失败: ${result.error}`, false, 'status-ng');
                }
            } catch (error) {
                displayMessage('recommendResults', `网络或服务器错误: ${error}`, false, 'status-ng');
            }
        }

        // --- 模块 4: AI侦探 (核心修改部分) ---
        async function predictQuality() {
            clearResults('predictResults');
            displayImage('shapPlotContainer', null);
            document.getElementById('suggestionButtonGroup').style.display = 'none';
            document.getElementById('adjustmentSuggestionResults').style.display = 'none';

            const params = getParameterInputs('predict');
            currentOriginalParams = params; // 存储原始参数

            try {
                const response = await fetch('/api/predict', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(params)
                });
                const result = await response.json();

                if (response.ok) {
                    let statusClass = '';
                    if (result.status === 'OK') {
                        statusClass = 'status-ok';
                    } else if (result.status === 'NG') {
                        statusClass = 'status-ng';
                    } else if (result.status === 'Warning') {
                        statusClass = 'status-warning';
                    }
                    
                    displayMessage('predictResults', `状态: <span class="${statusClass}">${result.status}</span><br>${result.message}`, true);

                    if (result.status === 'NG') {
                        displayImage('shapPlotContainer', result.shap_plot);
                        if (result.show_suggestion_button) {
                            document.getElementById('suggestionButtonGroup').style.display = 'flex'; // 显示按钮组
                            currentOriginalParams = result.original_params; // 存储服务器返回的原始参数（包含处理后的派生特征）
                        }
                    }

                } else {
                    displayMessage('predictResults', `诊断失败: ${result.error}`, false, 'status-ng');
                }
            } catch (error) {
                displayMessage('predictResults', `网络或服务器错误: ${error}`, false, 'status-ng');
            }
        }

        // 新增：获取调优建议的函数
        async function getAdjustmentSuggestion() {
            const adjustmentSuggestionResults = document.getElementById('adjustmentSuggestionResults');
            adjustmentSuggestionResults.style.display = 'block'; // 显示建议框
            adjustmentSuggestionResults.innerHTML = '正在计算调优建议...'; // 提示用户正在处理

            if (!currentOriginalParams) {
                adjustmentSuggestionResults.innerHTML = '<span class="status-ng">错误：未找到原始参数进行调优。请先进行质量诊断。</span>';
                return;
            }

            try {
                const response = await fetch('/api/get_adjustment_suggestion', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ original_params: currentOriginalParams })
                });
                const result = await response.json();

                if (response.ok) {
                    let msg = `<p><strong>调优建议:</strong><br>${result.suggestion.replace(/\n/g, '<br>')}</p>`;
                    let probClass = result.is_adjusted_ok ? 'status-ok' : 'status-ng';
                    msg += `<p class="prob-change">调整前合格概率: ${(result.original_prob_ok * 100).toFixed(2)}%</p>`;
                    msg += `<p class="prob-change">调整后预测合格概率: <span class="${probClass}">${(result.adjusted_prob_ok * 100).toFixed(2)}%</span></p>`;
                    if (result.is_adjusted_ok) {
                        msg += `<p class="status-ok">预测调整后可达到合格标准。</p>`;
                    } else {
                        msg += `<p class="status-ng">预测调整后仍未达到合格标准，可能需要进一步调优。</p>`;
                    }
                    adjustmentSuggestionResults.innerHTML = msg;
                } else {
                    adjustmentSuggestionResults.innerHTML = `<span class="status-ng">获取调优建议失败: ${result.error}</span>`;
                }
            } catch (error) {
                adjustmentSuggestionResults.innerHTML = `<span class="status-ng">网络或服务器错误: ${error}</span>`;
            }
        }

    </script>
</body>
</html>
