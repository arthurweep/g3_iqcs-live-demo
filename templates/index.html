<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>广州福耀玻璃AI质检系统 - 生产线监控</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
<style>
  html, body {
    height: 100%;
    margin: 0; padding: 0;
    background: #121212;
    color: #eee;
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    overflow: hidden;
  }
  .header {
    height: 60px;
    background: #222;
    display: flex;
    align-items: center;
    padding: 0 20px;
    font-weight: 700;
    font-size: 1.4rem;
    color: #0af;
    user-select: none;
    position: relative;
  }
  .header .status {
    margin-left: auto;
    font-weight: 800;
    font-size: 1.1rem;
    padding: 6px 14px;
    border-radius: 12px;
    color: white;
  }
  .status-ok {
    background-color: #28a745;
  }
  .status-warning {
    background-color: #fd7e14;
    animation: blink 1.5s infinite;
  }
  .status-ng {
    background-color: #dc3545;
    animation: blink 1s infinite;
  }
  @keyframes blink {
    0%, 100% {opacity: 1;}
    50% {opacity: 0.4;}
  }
  .container-fluid {
    height: calc(100% - 60px);
    display: flex;
    padding: 0;
  }
  .left-panel {
    width: 30%;
    background: #1c1c1c;
    overflow-y: auto;
    padding: 20px;
    border-right: 2px solid #0af;
  }
  .right-panel {
    flex-grow: 1;
    background: #181818;
    padding: 20px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
  }
  h2.section-title {
    color: #0af;
    font-weight: 700;
    margin-bottom: 1rem;
  }
  .param-item {
    padding: 10px 14px;
    margin-bottom: 8px;
    border-radius: 8px;
    background: #222;
    display: flex;
    justify-content: space-between;
    font-size: 1.1rem;
  }
  .param-item.ok {
    color: #28a745;
  }
  .param-item.warning {
    background: #ff8c00;
    color: #fff;
    font-weight: 700;
  }
  .param-item.ng {
    background: #dc3545;
    color: #fff;
    font-weight: 700;
  }
  .btn-primary {
    border-radius: 8px;
    font-weight: 700;
    padding: 10px 20px;
    font-size: 1.1rem;
  }
  .form-label {
    font-weight: 600;
  }
  .shap-img {
    max-width: 100%;
    border-radius: 12px;
    box-shadow: 0 0 20px #0af;
    margin-top: 20px;
  }
  .diagnosis {
    margin-top: 20px;
    font-size: 1.2rem;
    font-weight: 700;
  }
  .diagnosis.ok {
    color: #28a745;
  }
  .diagnosis.warning {
    color: #fd7e14;
  }
  .diagnosis.ng {
    color: #dc3545;
  }
  .scrollable-form {
    max-height: 300px;
    overflow-y: auto;
  }
</style>
</head>
<body>

<div class="header">
  福耀玻璃智能质检系统
  <div id="system-status" class="status status-ok">状态：正常</div>
</div>

<div class="container-fluid">
  <!-- 左侧参数监控 -->
  <div class="left-panel">
    <h2 class="section-title">关键参数实时监控</h2>
    <div id="param-list">
      <!-- 参数项动态填充 -->
    </div>
  </div>

  <!-- 右侧检测与诊断 -->
  <div class="right-panel">
    <h2 class="section-title">AI侦探 - 缺陷诊断与优化</h2>
    {% if not model_ready %}
    <div class="alert alert-warning text-dark">请先上传并训练模型以启用诊断功能。</div>
    {% else %}
    <form id="predict-form" class="scrollable-form">
      <div class="row g-3">
        {% for k, v in displayable_params %}
        <div class="col-6 col-md-4">
          <label for="{{ k }}" class="form-label">{{ v }}</label>
          <input type="number" step="any" class="form-control" id="{{ k }}" name="{{ k }}" required />
        </div>
        {% endfor %}
      </div>
      <div class="mt-3">
        <button type="submit" class="btn btn-primary">开始检测</button>
      </div>
    </form>
    <div id="predict-result" class="diagnosis mt-4"></div>
    <img id="shap-plot" class="shap-img d-none" alt="SHAP瀑布图" />
    <button id="optimize-btn" class="btn btn-warning mt-3 d-none">需要优化建议？</button>
    <div id="adjustment-result" class="diagnosis mt-3"></div>
    {% endif %}
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const paramListEl = document.getElementById('param-list');
  const systemStatusEl = document.getElementById('system-status');
  const predictForm = document.getElementById('predict-form');
  const predictResult = document.getElementById('predict-result');
  const shapPlot = document.getElementById('shap-plot');
  const optimizeBtn = document.getElementById('optimize-btn');
  const adjustmentResult = document.getElementById('adjustment-result');

  // TODO: 实际项目中请替换为后端接口实时拉取参数状态数据
  const exampleParams = [
    { name: "刀头实际压力", key: "F_cut_act", value: 50, status: "ok" },
    { name: "切割实际速度", key: "v_cut_act", value: 120, status: "warning" },
    { name: "崩边力峰值", key: "F_break_peak", value: 80, status: "ng" },
    { name: "磨轮线速度", key: "v_wheel_act", value: 200, status: "ok" },
    { name: "磨轮压紧力", key: "F_wheel_act", value: 30, status: "ok" }
  ];

  function renderParams(params) {
    paramListEl.innerHTML = '';
    params.forEach(p => {
      const div = document.createElement('div');
      div.className = `param-item ${p.status}`;
      div.textContent = `${p.name}: ${p.value}`;
      paramListEl.appendChild(div);
    });
  }

  renderParams(exampleParams);

  function updateSystemStatus() {
    const hasNG = exampleParams.some(p => p.status === 'ng');
    const hasWarning = exampleParams.some(p => p.status === 'warning');
    if (hasNG) {
      systemStatusEl.textContent = '状态：异常';
      systemStatusEl.className = 'status status-ng';
    } else if (hasWarning) {
      systemStatusEl.textContent = '状态：预警';
      systemStatusEl.className = 'status status-warning';
    } else {
      systemStatusEl.textContent = '状态：正常';
      systemStatusEl.className = 'status status-ok';
    }
  }

  updateSystemStatus();

  if (predictForm) {
    predictForm.onsubmit = function(e) {
      e.preventDefault();
      predictResult.textContent = '检测中，请稍候...';
      adjustmentResult.textContent = '';
      shapPlot.classList.add('d-none');
      optimizeBtn.classList.add('d-none');

      const formData = new FormData(predictForm);
      let data = {};
      formData.forEach((v, k) => data[k] = parseFloat(v));

      fetch('/api/predict', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
      }).then(res => res.json()).then(res => {
        if (res.error) {
          predictResult.textContent = res.error;
          return;
        }

        predictResult.className = 'diagnosis mt-4';
        predictResult.innerHTML = `
          <div><strong>检测结果：</strong> ${res.status === 'ok' ? '合格' : (res.status === 'ng' ? '不合格' : '预警')}</div>
          <div><strong>合格概率：</strong> ${(res.prob*100).toFixed(2)}%</div>
          <ul>${res.verdict_reason.map(r => `<li>${r}</li>`).join('')}</ul>
        `;

        if (res.status === 'ok') predictResult.classList.add('ok');
        else if (res.status === 'warning') predictResult.classList.add('warning');
        else predictResult.classList.add('ng');

        if (res.waterfall_plot) {
          shapPlot.src = "data:image/png;base64," + res.waterfall_plot;
          shapPlot.classList.remove('d-none');
        }

        if (res.can_optimize) {
          optimizeBtn.classList.remove('d-none');
          optimizeBtn.onclick = () => {
            adjustmentResult.textContent = '优化建议生成中...';
            fetch('/api/adjust', {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify({
                input_data: res.input_data,
                shap_values: res.shap_values
              })
            }).then(r => r.json()).then(adj => {
              if (adj.error) {
                adjustmentResult.textContent = adj.error;
                return;
              }
              adjustmentResult.innerHTML = '<strong>参数优化建议：</strong><br/>' +
                Object.entries(adj.adjustments).map(([k, v]) => 
                  `${res.param_map[k]}: 原值 ${v.original_value} → 建议 ${v.suggested_value}，提升概率 ${(v.prob_contribution*100).toFixed(2)}%`
                ).join('<br/>') + `<br/><br/>${adj.message}`;
            });
          };
        } else {
          optimizeBtn.classList.add('d-none');
          adjustmentResult.textContent = '';
        }
      });
    };
  }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
