<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <title>福耀玻璃智能质检系统</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
        html, body { height: 100%; margin: 0; padding: 0; background: #15181b; color: #eee; font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; }
        .header { height: 64px; background: #181f27; display: flex; align-items: center; padding: 0 32px; font-weight: 700; font-size: 1.5rem; color: #19aaff; }
        .header .status { margin-left: auto; font-weight: 800; font-size: 1.1rem; padding: 7px 18px; border-radius: 14px; color: white; }
        .status-ok { background: #28a745; }
        .status-warning { background: #fd7e14; animation: blink 1.5s infinite; }
        .status-ng { background: #dc3545; animation: blink 1s infinite; }
        @keyframes blink { 0%, 100% {opacity: 1;} 50% {opacity: 0.4;} }
        .main-flex { display: flex; flex-direction: row; height: calc(100vh - 64px); }
        .side-panel { width: 300px; background: #1c232b; padding: 28px 18px 18px 18px; border-right: 2px solid #19aaff; }
        .main-panel { flex: 1; padding: 28px 32px 18px 32px; overflow-y: auto; }
        .card { background: #232a31; border-radius: 14px; box-shadow: 0 2px 24px #0006; margin-bottom: 28px; }
        .card-title { color: #19aaff; font-weight: 700; font-size: 1.25rem; margin-bottom: 1rem; }
        .param-list .param-item { padding: 10px 14px; margin-bottom: 10px; border-radius: 8px; background: #232a31; display: flex; justify-content: space-between; font-size: 1.1rem; }
        .param-item.ok { color: #28a745; }
        .param-item.warning { background: #ff8c00; color: #fff; font-weight: 700; }
        .param-item.ng { background: #dc3545; color: #fff; font-weight: 700; }
        .shap-img { max-width: 100%; border-radius: 12px; box-shadow: 0 0 20px #19aaff; margin-top: 20px; }
        .diagnosis { font-size: 1.15rem; font-weight: 700; }
        .diagnosis.ok { color: #28a745; }
        .diagnosis.warning { color: #fd7e14; }
        .diagnosis.ng { color: #dc3545; }
        .section-row { display: flex; gap: 32px; }
        .section-col { flex: 1; min-width: 350px; }
        .alert { color: #222; }
        @media (max-width: 1100px) {
            .section-row { flex-direction: column; gap: 0; }
            .main-panel { padding: 14px 8px; }
        }
        @media (max-width: 700px) {
            .main-flex { flex-direction: column; }
            .side-panel { width: 100%; border-right: none; border-bottom: 2px solid #19aaff; }
        }
    </style>
</head>
<body>
<div class="header">
    福耀玻璃智能质检系统
    <div id="system-status" class="status status-ok">状态：正常</div>
</div>
<div class="main-flex">
    <!-- 侧边栏：参数监控+上传 -->
    <div class="side-panel">
        <div class="card mb-4">
            <div class="card-title">关键参数实时监控</div>
            <div id="param-list" class="param-list">
                <!-- 动态填充参数项 -->
            </div>
        </div>
        <div class="card">
            <div class="card-title" style="font-size:1.1rem;">上传训练数据</div>
            <form method="post" action="/train" enctype="multipart/form-data" class="mb-2">
                <input type="file" name="file" accept=".csv" required class="form-control form-control-sm mb-2" />
                <button type="submit" class="btn btn-primary btn-sm">上传并训练</button>
            </form>
            {% if model_ready %}
              <div class="text-muted" style="font-size:0.95rem;">已上传文件: <strong>{{ cache.filename }}</strong></div>
            {% endif %}
        </div>
    </div>

    <!-- 主区：所有功能模块并列展示 -->
    <div class="main-panel">
        <div class="section-row">
            <!-- AI侦探 -->
            <div class="section-col">
                <div class="card p-3">
                    <div class="card-title">AI侦探 - 缺陷诊断与优化</div>
                    {% if not model_ready %}
                    <div class="alert alert-warning">请先上传并训练模型以启用诊断功能。</div>
                    {% else %}
                    <form id="predict-form" class="mb-3">
                        <div class="row g-3">
                            {% for k, v in displayable_params %}
                            <div class="col-6">
                                <label for="{{ k }}" class="form-label">{{ v }}</label>
                                <input type="number" step="any" class="form-control" id="{{ k }}" name="{{ k }}" required />
                            </div>
                            {% endfor %}
                        </div>
                        <div class="mt-3">
                            <button type="submit" class="btn btn-primary">开始检测</button>
                        </div>
                    </form>
                    <div id="predict-result" class="diagnosis mt-4"></div>
                    <img id="shap-plot" class="shap-img d-none" alt="SHAP瀑布图" />
                    <button id="optimize-btn" class="btn btn-warning mt-3 d-none">需要优化建议？</button>
                    <div id="adjustment-result" class="diagnosis mt-3"></div>
                    {% endif %}
                </div>
            </div>
            <!-- 产线心电图 -->
            <div class="section-col">
                <div class="card p-3">
                    <div class="card-title">产线心电图（实时参数监控）</div>
                    <!-- 填入您的产线心电图功能模块内容或表单 -->
                    <div class="alert alert-secondary">此处可集成实时工艺参数趋势图、报警记录等。</div>
                </div>
            </div>
        </div>
        <div class="section-row">
            <!-- AI工艺员 -->
            <div class="section-col">
                <div class="card p-3">
                    <div class="card-title">AI工艺员（新品参数推荐）</div>
                    <!-- 填入您的AI工艺员功能模块内容或表单 -->
                    <div class="alert alert-secondary">此处可集成新品参数推荐、工艺知识库等。</div>
                </div>
            </div>
            <!-- 模型训练结果 -->
            <div class="section-col">
                <div class="card p-3">
                    <div class="card-title">模型训练结果</div>
                    {% if model_ready %}
                    <table class="table table-dark table-bordered w-auto mb-3">
                        <tbody>
                            <tr><th>准确率</th><td>{{ "%.2f%%"|format(cache.metrics.accuracy*100) }}</td></tr>
                            <tr><th>不合格品召回率</th><td>{{ "%.2f%%"|format(cache.metrics.recall_ng*100) }}</td></tr>
                            <tr><th>不合格品精确率</th><td>{{ "%.2f%%"|format(cache.metrics.precision_ng*100) }}</td></tr>
                            <tr><th>不合格品F1分数</th><td>{{ "%.3f"|format(cache.metrics.f1_ng) }}</td></tr>
                        </tbody>
                    </table>
                    <h5>特征重要性</h5>
                    <img src="data:image/png;base64,{{ cache.feature_plot }}" alt="特征重要性" class="shap-img" />
                    {% else %}
                    <div class="alert alert-info">暂无训练结果，请先上传数据。</div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // 参数监控示例（实际请用后端接口填充）
  const paramListEl = document.getElementById('param-list');
  const systemStatusEl = document.getElementById('system-status');
  const exampleParams = [
    { name: "刀头实际压力", key: "F_cut_act", value: 50, status: "ok" },
    { name: "切割实际速度", key: "v_cut_act", value: 120, status: "warning" },
    { name: "崩边力峰值", key: "F_break_peak", value: 80, status: "ng" },
    { name: "磨轮线速度", key: "v_wheel_act", value: 200, status: "ok" },
    { name: "磨轮压紧力", key: "F_wheel_act", value: 30, status: "ok" }
  ];
  function renderParams(params) {
    paramListEl.innerHTML = '';
    params.forEach(p => {
      const div = document.createElement('div');
      div.className = `param-item ${p.status}`;
      div.textContent = `${p.name}: ${p.value}`;
      paramListEl.appendChild(div);
    });
  }
  renderParams(exampleParams);
  function updateSystemStatus() {
    const hasNG = exampleParams.some(p => p.status === 'ng');
    const hasWarning = exampleParams.some(p => p.status === 'warning');
    if (hasNG) {
      systemStatusEl.textContent = '状态：异常';
      systemStatusEl.className = 'status status-ng';
    } else if (hasWarning) {
      systemStatusEl.textContent = '状态：预警';
      systemStatusEl.className = 'status status-warning';
    } else {
      systemStatusEl.textContent = '状态：正常';
      systemStatusEl.className = 'status status-ok';
    }
  }
  updateSystemStatus();

  // 下面保持您的AI侦探等原有JS逻辑不变
  const predictForm = document.getElementById('predict-form');
  const predictResult = document.getElementById('predict-result');
  const shapPlot = document.getElementById('shap-plot');
  const optimizeBtn = document.getElementById('optimize-btn');
  const adjustmentResult = document.getElementById('adjustment-result');
  if (predictForm) {
    predictForm.onsubmit = function(e) {
      e.preventDefault();
      predictResult.textContent = '检测中，请稍候...';
      adjustmentResult.textContent = '';
      shapPlot.classList.add('d-none');
      optimizeBtn.classList.add('d-none');
      const formData = new FormData(predictForm);
      let data = {};
      formData.forEach((v, k) => data[k] = parseFloat(v));
      fetch('/api/predict', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
      }).then(res => res.json()).then(res => {
        if (res.error) {
          predictResult.textContent = res.error;
          return;
        }
        predictResult.className = 'diagnosis mt-4';
        predictResult.innerHTML = `
          <div><strong>检测结果：</strong> ${res.status === 'ok' ? '合格' : (res.status === 'ng' ? '不合格' : '预警')}</div>
          <div><strong>合格概率：</strong> ${(res.prob*100).toFixed(2)}%</div>
          <ul>${res.verdict_reason.map(r => `<li>${r}</li>`).join('')}</ul>
        `;
        if (res.status === 'ok') predictResult.classList.add('ok');
        else if (res.status === 'warning') predictResult.classList.add('warning');
        else predictResult.classList.add('ng');
        if (res.waterfall_plot) {
          shapPlot.src = "data:image/png;base64," + res.waterfall_plot;
          shapPlot.classList.remove('d-none');
        }
        if (res.can_optimize) {
          optimizeBtn.classList.remove('d-none');
          optimizeBtn.onclick = () => {
            adjustmentResult.textContent = '优化建议生成中...';
            fetch('/api/adjust', {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify({
                input_data: res.input_data,
                shap_values: res.shap_values
              })
            }).then(r => r.json()).then(adj => {
              if (adj.error) {
                adjustmentResult.textContent = adj.error;
                return;
              }
              adjustmentResult.innerHTML = '<strong>参数优化建议：</strong><br/>' +
                Object.entries(adj.adjustments).map(([k, v]) =>
                  `${res.param_map[k]}: 原值 ${v.original_value} → 建议 ${v.suggested_value}，提升概率 ${(v.prob_contribution*100).toFixed(2)}%`
                ).join('<br/>') + `<br/><br/>${adj.message}`;
            });
          };
        } else {
          optimizeBtn.classList.add('d-none');
          adjustmentResult.textContent = '';
        }
      });
    };
  }
</script>
</body>
</html>
