<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>智能玻璃质检系统 (IQCS) - 演示版</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 2em; background-color: #f4f7f6; color: #333; }
        h1, h2, h3, h4 { color: #0056b3; }
        h3 { border-bottom: 1px solid #007bff; padding-bottom: 0.3em; }
        .main-container { max-width: 1600px; margin: auto; }
        .grid-container { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 2em; }
        .module { background: white; padding: 1.5em; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .upload-section { grid-column: 1 / -1; margin-bottom: 2em; }
        input, button { width: calc(100% - 22px); padding: 10px; margin-bottom: 10px; border-radius: 4px; border: 1px solid #ccc; font-size: 14px; }
        button { background-color: #007bff; color: white; border: none; cursor: pointer; font-weight: bold; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; display: none; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .results-box { margin-top: 1em; padding: 1em; background-color: #e9ecef; border-radius: 4px; min-height: 50px; }
        .param-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0 1em; }
        .flash-message { padding: 1em; margin-bottom: 1em; border-radius: 4px; }
        .flash-success { background-color: #d4edda; color: #155724; }
        .flash-error { background-color: #f8d7da; color: #721c24; }
        table { width: 100%; border-collapse: collapse; margin-top: 1em; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
        th { background-color: #007bff; color: white; }
        .verdict-box { border-left-width: 5px; border-left-style: solid; padding: 0.5em 1em; margin-top: 1em; border-radius: 4px; }
        .status-ok { border-left-color: green; background-color: #e8f5e9; }
        .status-warning { border-left-color: orange; background-color: #fff3e0; }
        .status-ng { border-left-color: red; background-color: #ffebee; }
    </style>
</head>
<body>
    <div class="main-container">
        <h1>智能玻璃质检系统 (IQCS) - 实时上传训练演示版</h1>
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}{% for c, m in messages %}<div class="flash-message flash-{{ c }}">{{ m }}</div>{% endfor %}{% endif %}
        {% endwith %}

        <div class="module upload-section">
            <h2>步骤一：上传数据并实时训练AI模型</h2>
            <form action="/train" method="post" enctype="multipart/form-data"><input type="file" name="file" required><button type="submit">上传并开始训练</button></form>
        </div>
        
        {% if model_ready %}
        <!-- ... (训练结果概览 HTML 保持不变) ... -->

        <div class="grid-container">
            <div class="module">
                <h2>模块一：产线心电图</h2>
                <form id="monitor-form"><div class="param-grid">
                    {% for feature, name in cache.param_map.items() %}
                        {% if not any(k in feature for k in ['product_id', 'ratio', 'indicator', 'density']) %}
                        <div><label for="monitor_{{ feature }}">{{ name }}:</label><input type="number" step="any" id="monitor_{{ feature }}" name="{{ feature }}" value="{{ cache.feature_defaults.get(feature, 0) | round(3) }}" required></div>
                        {% endif %}
                    {% endfor %}
                </div><button type="submit">监控检查</button></form>
                <div id="monitor-spinner" class="spinner"></div><div id="monitor-results" class="results-box"></div>
            </div>
            <div class="module">
                <h2>模块二：AI工艺员</h2>
                <form id="recommend-form"><label for="product_id">产品ID (例如: A, B, C):</label><input type="text" id="product_id" name="product_id" value="A" required><button type="submit">获取推荐参数</button></form>
                <div id="recommend-spinner" class="spinner"></div><div id="recommend-results" class="results-box"></div>
            </div>
            <div class="module">
                <h2>模块三：AI侦探</h2>
                <form id="predict-form"><div class="param-grid">
                     {% for feature, name in cache.param_map.items() %}
                        {% if not any(k in feature for k in ['product_id', 'ratio', 'indicator', 'density']) %}
                        <div><label for="{{ feature }}">{{ name }}:</label><input type="number" step="any" id="{{ feature }}" name="{{ feature }}" value="{{ cache.feature_defaults.get(feature, 0) | round(3) }}" required></div>
                        {% endif %}
                     {% endfor %}
                </div><button type="submit">开始诊断</button></form>
                <div id="predict-spinner" class="spinner"></div><div id="predict-results" class="results-box"></div>
            </div>
        </div>
        {% else %}
        <div class="module upload-section"><p style="text-align: center; font-weight: bold;">系统尚未训练，请先上传数据文件以激活全部功能。</p></div>
        {% endif %}
    </div>

    <script>
        // ... (handleApiCall, displayMonitorResults, displayRecommendResults 函数保持不变) ...

        async function displayPredictResults(resultsId, result, payload) {
            const el = document.getElementById(resultsId);
            
            let statusText, statusClass;
            if (result.status === 'ok') {
                statusText = '合格 (OK)'; statusClass = 'status-ok';
            } else if (result.status === 'warning') {
                statusText = '过程预警 (Warning)'; statusClass = 'status-warning';
            } else {
                statusText = '不合格 (NG)'; statusClass = 'status-ng';
            }

            let reasonHTML = `<h4>诊断依据</h4><ul>${result.verdict_reason.map(r => `<li>${r}</li>`).join('')}</ul>`;

            el.innerHTML = `<h3>诊断结论</h3>
                <div class="verdict-box ${statusClass}">
                    <p style="font-weight:bold; font-size: 1.2em;">最终判定: ${statusText}</p>
                    ${reasonHTML}
                </div>
                <h4>AI模型内部判断</h4>
                <table>
                <tr><td>AI模型预测合格概率</td><td>${(result.prob * 100).toFixed(2)}%</td></tr>
                <tr><td>判定阈值</td><td>>${(result.threshold * 100).toFixed(2)}%</td></tr>
                </table>
                <h3>根因分析 (SHAP图)</h3>
                <img src="data:image/png;base64,${result.waterfall_plot}" alt="SHAP Plot" style="max-width: 100%;">
                <div id="adjustment-section" class="results-box" style="margin-top:1em;"></div>`;
            
            if (result.status === 'ng') { // 只在最终判定为NG时才触发调整建议
                const adjSection = document.getElementById('adjustment-section');
                adjSection.innerHTML = '<h3>正在生成调整建议...</h3><div class="spinner" style="display:block;"></div>';
                try {
                    const adjPayload = { input_data: result.input_data, shap_values: result.shap_values };
                    const adjResponse = await fetch('/api/adjust', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(adjPayload) });
                    const adjResult = await adjResponse.json();
                    if (!adjResponse.ok) throw new Error(adjResult.error || '获取建议失败');
                    displayAdjustmentResults('adjustment-section', adjResult, result.threshold);
                } catch (error) { adjSection.innerHTML = `<p style="color: red;">获取调整建议时出错: ${error.message}</p>`; }
            }
        }
        
        // ... (displayAdjustmentResults 和 handleApiCall 绑定事件的函数保持不变) ...
    </script>
</body>
</html>
